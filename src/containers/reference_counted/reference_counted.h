#pragma once

#include "common.h"

#include <memory/allocator/allocator.h>

#include <primitives/primitives.h>

// types
#define REFERENCE_COUNTED_CONTROL_BLOCK_TYPE_WITH_CUSTOM_VALUE_ALLOCATOR(VALUE_ALLOCATOR)\
    NAMESPACE_REFERENCE_COUNTED(\
        CONCAT5(CONCAT3(rc, __, control_block), _, with_value_allocator, _, VALUE_ALLOCATOR)\
    )

#define REFERENCE_COUNTED_CONTROL_BLOCK_TYPE(TYPE)\
    REFERENCE_COUNTED_CONTROL_BLOCK_TYPE_WITH_CUSTOM_VALUE_ALLOCATOR(DEFAULT_ALLOCATOR_TYPE(TYPE))


#define REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR)\
    NAMESPACE_REFERENCE_COUNTED(\
        CONCAT5(\
            CONCAT5(\
                CONCAT3(rc, __, TYPE), _, with_value_allocator, _, VALUE_ALLOCATOR\
            ), _, and_control_block_allocator, _, CONTROL_BLOCK_ALLOCATOR\
        )\
    )

#define REFERENCE_COUNTED_TYPE_WITH_CUSTOM_VALUE_ALLOCATOR(TYPE, VALUE_ALLOCATOR)\
    REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR,\
        DEFAULT_ALLOCATOR_TYPE(REFERENCE_COUNTED_CONTROL_BLOCK_TYPE_WITH_CUSTOM_VALUE_ALLOCATOR(VALUE_ALLOCATOR)))

#define REFERENCE_COUNTED_TYPE(TYPE)\
    REFERENCE_COUNTED_TYPE_WITH_CUSTOM_VALUE_ALLOCATOR(TYPE, DEFAULT_ALLOCATOR_TYPE(TYPE))


// types definitions
/// rc::control_block<Allocator<Type>>
#define DEFINE_REFERENCE_COUNTED_CONTROL_BLOCK_TYPE_WITH_CUSTOM_VALUE_ALLOCATOR(VALUE_ALLOCATOR)\
DECLARE_STRUCT_SUBTYPE(REFERENCE_COUNTED_CONTROL_BLOCK_TYPE_WITH_CUSTOM_VALUE_ALLOCATOR(VALUE_ALLOCATOR),\
    value_allocator_type, VALUE_ALLOCATOR);\
DECLARE_STRUCT_SUBTYPE(REFERENCE_COUNTED_CONTROL_BLOCK_TYPE_WITH_CUSTOM_VALUE_ALLOCATOR(VALUE_ALLOCATOR),\
    size_type, usize);\
typedef struct REFERENCE_COUNTED_CONTROL_BLOCK_TYPE_WITH_CUSTOM_VALUE_ALLOCATOR(VALUE_ALLOCATOR) {\
    STRUCT_SUBTYPE(REFERENCE_COUNTED_CONTROL_BLOCK_TYPE_WITH_CUSTOM_VALUE_ALLOCATOR(VALUE_ALLOCATOR),\
        size_type) strong_reference_counter;\
    STRUCT_SUBTYPE(REFERENCE_COUNTED_CONTROL_BLOCK_TYPE_WITH_CUSTOM_VALUE_ALLOCATOR(VALUE_ALLOCATOR),\
        size_type) weak_reference_counter;\
    STRUCT_SUBTYPE(REFERENCE_COUNTED_CONTROL_BLOCK_TYPE_WITH_CUSTOM_VALUE_ALLOCATOR(VALUE_ALLOCATOR),\
        value_allocator_type) value_allocator;\
} REFERENCE_COUNTED_CONTROL_BLOCK_TYPE_WITH_CUSTOM_VALUE_ALLOCATOR(VALUE_ALLOCATOR)

#define DEFINE_REFERENCE_COUNTED_CONTROL_BLOCK_TYPE(TYPE)\
    DEFINE_REFERENCE_COUNTED_CONTROL_BLOCK_TYPE_WITH_CUSTOM_VALUE_ALLOCATOR(DEFAULT_ALLOCATOR_TYPE(TYPE))

/// rc<Type, Allocator<Type>, Allocator<rc::control_block>>
#define DEFINE_REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR)\
DECLARE_STRUCT_SUBTYPE(REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR),\
    value_allocator_type, VALUE_ALLOCATOR);\
DECLARE_STRUCT_SUBTYPE(REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR),\
    value_type, TYPE);\
DECLARE_STRUCT_SUBTYPE(REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR),\
    control_block_allocator_type, CONTROL_BLOCK_ALLOCATOR);\
DECLARE_STRUCT_SUBTYPE(REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR),\
    control_block_type, REFERENCE_COUNTED_CONTROL_BLOCK_TYPE_WITH_CUSTOM_VALUE_ALLOCATOR(VALUE_ALLOCATOR));\
typedef struct REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR) {\
    STRUCT_SUBTYPE(REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR), control_block_type)* control_block_pointer;\
    STRUCT_SUBTYPE(REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR), value_type)* value_pointer;\
    STRUCT_SUBTYPE(REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR), control_block_allocator_type) control_block_allocator;\
} REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR)

#define DEFINE_REFERENCE_COUNTED_TYPE_WITH_CUSTOM_VALUE_ALLOCATOR(TYPE, VALUE_ALLOCATOR)\
    DEFINE_REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR,\
        DEFAULT_ALLOCATOR_TYPE(REFERENCE_COUNTED_CONTROL_BLOCK_TYPE_WITH_CUSTOM_VALUE_ALLOCATOR(VALUE_ALLOCATOR)))

#define DEFINE_REFERENCE_COUNTED_TYPE(TYPE)\
    DEFINE_REFERENCE_COUNTED_TYPE_WITH_CUSTOM_VALUE_ALLOCATOR(TYPE, DEFAULT_ALLOCATOR_TYPE(TYPE))

// methods
#define REFERENCE_COUNTED_WITH_CUSTOM_ALLOCATORS_METHOD(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR, METHOD)\
    TYPE_METHOD(REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR), METHOD)

#define REFERENCE_COUNTED_WITH_CUSTOM_VALUE_ALLOCATOR_METHOD(TYPE, VALUE_ALLOCATOR, METHOD)\
    TYPE_METHOD(REFERENCE_COUNTED_TYPE_WITH_CUSTOM_VALUE_ALLOCATOR(TYPE, VALUE_ALLOCATOR), METHOD)

#define REFERENCE_COUNTED_METHOD(TYPE, METHOD)\
    TYPE_METHOD(REFERENCE_COUNTED_TYPE(TYPE), METHOD)

// methods declarations
#define DECLARE_REFERENCE_COUNTED_WITH_CUSTOM_ALLOCATORS_METHODS_WITH_MODIFIER(MODIFIER, TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR)\
/* --- Construction/Destruction functions --- */\
MODIFIER struct REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR)*\
    REFERENCE_COUNTED_WITH_CUSTOM_ALLOCATORS_METHOD(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR, construct_at)(\
        struct REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR)* const this);\
MODIFIER struct REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR)*\
    REFERENCE_COUNTED_WITH_CUSTOM_ALLOCATORS_METHOD(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR, construct_copy_at)(\
        struct REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR)* const this,\
        struct REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR) const* const source);\
MODIFIER struct REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR)*\
    REFERENCE_COUNTED_WITH_CUSTOM_ALLOCATORS_METHOD(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR, construct_move_at)(\
        struct REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR)* const this,\
        struct REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR)* const source);\
MODIFIER void*\
    REFERENCE_COUNTED_WITH_CUSTOM_ALLOCATORS_METHOD(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR, destroy_at)(\
        struct REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR)* const this);\
/* --- Assign functions --- */\
MODIFIER struct REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR)*\
    REFERENCE_COUNTED_WITH_CUSTOM_ALLOCATORS_METHOD(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR, assign_copy_at)(\
        struct REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR)* const this,\
        struct REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR) const* const source);\
MODIFIER struct REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR)*\
    REFERENCE_COUNTED_WITH_CUSTOM_ALLOCATORS_METHOD(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR, assign_move_at)(\
        struct REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR)* const this,\
        struct REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR)* const source);\
/* --- Swap --- */\
MODIFIER void\
    REFERENCE_COUNTED_WITH_CUSTOM_ALLOCATORS_METHOD(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR, swap)(\
        struct REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR)* const this,\
        struct REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR)* const another);\
/* --- Non-default methods --- */\
MODIFIER REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR)*\
    REFERENCE_COUNTED_WITH_CUSTOM_ALLOCATORS_METHOD(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR, construct_from_value_pointer_at)(\
        struct REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR)* const this,\
        STRUCT_SUBTYPE(REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR), value_type)* const pointer);\
MODIFIER REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR)*\
    REFERENCE_COUNTED_WITH_CUSTOM_ALLOCATORS_METHOD(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR, assign_from_value_pointer_at)(\
        struct REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR)* const this,\
        STRUCT_SUBTYPE(REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR), value_type)* const pointer);\
MODIFIER STRUCT_SUBTYPE(REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR), value_type) const*\
    REFERENCE_COUNTED_WITH_CUSTOM_ALLOCATORS_METHOD(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR, get)(\
        struct REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR) const* const this);\
MODIFIER STRUCT_SUBTYPE(REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR), value_type)*\
    REFERENCE_COUNTED_WITH_CUSTOM_ALLOCATORS_METHOD(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR, mut_get)(\
        struct REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR)* const this);\
MODIFIER STRUCT_SUBTYPE(REFERENCE_COUNTED_CONTROL_BLOCK_TYPE_WITH_CUSTOM_VALUE_ALLOCATOR(VALUE_ALLOCATOR), size_type)\
    REFERENCE_COUNTED_WITH_CUSTOM_ALLOCATORS_METHOD(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR, count_owners)(\
        struct REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR) const* const this)

#define DECLARE_REFERENCE_COUNTED_WITH_CUSTOM_VALUE_ALLOCATOR_METHODS_WITH_MODIFIER(MODIFIER, TYPE, VALUE_ALLOCATOR)\
    DECLARE_REFERENCE_COUNTED_WITH_CUSTOM_ALLOCATORS_METHODS_WITH_MODIFIER(MODIFIER, TYPE, VALUE_ALLOCATOR,\
        DEFAULT_ALLOCATOR_TYPE(REFERENCE_COUNTED_CONTROL_BLOCK_TYPE_WITH_CUSTOM_VALUE_ALLOCATOR(VALUE_ALLOCATOR)))

#define DECLARE_REFERENCE_COUNTED_METHODS_WITH_MODIFIER(MODIFIER, TYPE)\
    DECLARE_REFERENCE_COUNTED_WITH_CUSTOM_VALUE_ALLOCATOR_METHODS_WITH_MODIFIER(MODIFIER, TYPE, DEFAULT_ALLOCATOR_TYPE(TYPE))

// methods definitions
#define DEFINE_REFERENCE_COUNTED_WITH_CUSTOM_ALLOCATORS_METHODS_WITH_MODIFIER(MODIFIER, TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR)\
/* --- Construction/Destruction functions --- */\
MODIFIER struct REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR)*\
    REFERENCE_COUNTED_WITH_CUSTOM_ALLOCATORS_METHOD(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR, construct_at)(\
        struct REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR)* const this) {\
    ASSERT(this);\
    this->control_block_pointer = NULL;\
    this->value_pointer = NULL;\
    TYPE_METHOD(CONTROL_BLOCK_ALLOCATOR, construct_at)(&this->control_block_allocator);\
    return this;\
}\
MODIFIER struct REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR)*\
    REFERENCE_COUNTED_WITH_CUSTOM_ALLOCATORS_METHOD(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR, construct_copy_at)(\
        struct REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR)* const this,\
        struct REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR) const* const source) {\
    ASSERT(this);\
    ASSERT(source);\
    this->control_block_pointer = source->control_block_pointer;\
    if (this->control_block_pointer) {\
        ++this->control_block_pointer->strong_reference_counter;\
    }\
    this->value_pointer = source->value_pointer;\
    TYPE_METHOD(CONTROL_BLOCK_ALLOCATOR, construct_copy_at)(&this->control_block_allocator, &source->control_block_allocator);\
    return this;\
}\
MODIFIER struct REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR)*\
    REFERENCE_COUNTED_WITH_CUSTOM_ALLOCATORS_METHOD(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR, construct_move_at)(\
        struct REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR)* const this,\
        struct REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR)* const source) {\
    ASSERT(this);\
    ASSERT(source);\
    this->control_block_pointer = source->control_block_pointer; source->control_block_pointer = NULL;\
    this->value_pointer = source->value_pointer; source->value_pointer = NULL;\
    TYPE_METHOD(CONTROL_BLOCK_ALLOCATOR, construct_move_at)(&this->control_block_allocator, &source->control_block_allocator);\
    return this;\
}\
MODIFIER void*\
    REFERENCE_COUNTED_WITH_CUSTOM_ALLOCATORS_METHOD(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR, destroy_at)(\
        struct REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR)* const this) {\
    ASSERT(this);\
    do {\
        if (!this->control_block_pointer) {\
            break;\
        }\
        if (this->control_block_pointer->strong_reference_counter) {\
            --this->control_block_pointer->strong_reference_counter;\
            break;\
        }\
        TYPE_METHOD(TYPE, destroy_at)(this->value_pointer);\
        TYPE_METHOD(VALUE_ALLOCATOR, deallocate)(&this->control_block_pointer->value_allocator, this->value_pointer, 1u);\
        TYPE_METHOD(VALUE_ALLOCATOR, destroy_at)(&this->control_block_pointer->value_allocator);\
        if (this->control_block_pointer->weak_reference_counter) {\
            break;\
        }\
        TYPE_METHOD(CONTROL_BLOCK_ALLOCATOR, deallocate)(&this->control_block_allocator, this->control_block_pointer, 1u);\
    } while(0);\
    TYPE_METHOD(CONTROL_BLOCK_ALLOCATOR, destroy_at)(&this->control_block_allocator);\
    return this;\
}\
/* --- Assign functions --- */\
MODIFIER struct REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR)*\
    REFERENCE_COUNTED_WITH_CUSTOM_ALLOCATORS_METHOD(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR, assign_copy_at)(\
        struct REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR)* const this,\
        struct REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR) const* const source) {\
    ASSERT(this);\
    ASSERT(source);\
    REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR) temporary;\
    REFERENCE_COUNTED_WITH_CUSTOM_ALLOCATORS_METHOD(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR, construct_copy_at)(&temporary, source);\
    REFERENCE_COUNTED_WITH_CUSTOM_ALLOCATORS_METHOD(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR, swap)(&temporary, this);\
    REFERENCE_COUNTED_WITH_CUSTOM_ALLOCATORS_METHOD(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR, destroy_at)(&temporary);\
    return this;\
}\
MODIFIER struct REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR)*\
    REFERENCE_COUNTED_WITH_CUSTOM_ALLOCATORS_METHOD(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR, assign_move_at)(\
        struct REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR)* const this,\
        struct REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR)* const source) {\
    ASSERT(this);\
    ASSERT(source);\
    REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR) temporary;\
    REFERENCE_COUNTED_WITH_CUSTOM_ALLOCATORS_METHOD(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR, construct_move_at)(&temporary, source);\
    REFERENCE_COUNTED_WITH_CUSTOM_ALLOCATORS_METHOD(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR, swap)(&temporary, this);\
    REFERENCE_COUNTED_WITH_CUSTOM_ALLOCATORS_METHOD(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR, destroy_at)(&temporary);\
    return this;\
}\
/* --- Swap --- */\
MODIFIER void\
    REFERENCE_COUNTED_WITH_CUSTOM_ALLOCATORS_METHOD(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR, swap)(\
        struct REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR)* const this,\
        struct REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR)* const another) {\
    ASSERT(this);\
    ASSERT(another);\
    {\
        STRUCT_SUBTYPE(REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR),\
            control_block_type)* temporary = this->control_block_pointer;\
        this->control_block_pointer = another->control_block_pointer;\
        another->control_block_pointer = temporary;\
    }\
    {\
        STRUCT_SUBTYPE(REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR),\
            value_type)* temporary = this->value_pointer;\
        this->value_pointer = another->value_pointer;\
        another->value_pointer = temporary;\
    }\
    TYPE_METHOD(CONTROL_BLOCK_ALLOCATOR, swap)(&this->control_block_allocator, &another->control_block_allocator);\
}\
/* --- Non-default methods --- */\
MODIFIER REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR)*\
    REFERENCE_COUNTED_WITH_CUSTOM_ALLOCATORS_METHOD(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR, construct_from_value_pointer_at)(\
        struct REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR)* const this,\
        STRUCT_SUBTYPE(REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR), value_type)* const pointer) {\
    ASSERT(this);\
    if (!pointer) {\
        return REFERENCE_COUNTED_WITH_CUSTOM_ALLOCATORS_METHOD(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR, construct_at)(this);\
    }\
    TYPE_METHOD(CONTROL_BLOCK_ALLOCATOR, construct_at)(&this->control_block_allocator);\
    this->control_block_pointer = TYPE_METHOD(CONTROL_BLOCK_ALLOCATOR, allocate)(&this->control_block_allocator, 1u);\
    TYPE_METHOD(VALUE_ALLOCATOR, construct_at)(&this->control_block_pointer->value_allocator);\
    this->control_block_pointer->strong_reference_counter = 0u;\
    this->control_block_pointer->weak_reference_counter = 0u;\
    this->value_pointer = pointer;\
    return this;\
}\
MODIFIER REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR)*\
    REFERENCE_COUNTED_WITH_CUSTOM_ALLOCATORS_METHOD(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR, assign_from_value_pointer_at)(\
        struct REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR)* const this,\
        STRUCT_SUBTYPE(REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR), value_type)* const pointer) {\
    ASSERT(this);\
    REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR) temporary;\
    REFERENCE_COUNTED_WITH_CUSTOM_ALLOCATORS_METHOD(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR, construct_from_value_pointer_at)(&temporary, pointer);\
    REFERENCE_COUNTED_WITH_CUSTOM_ALLOCATORS_METHOD(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR, swap)(&temporary, this);\
    REFERENCE_COUNTED_WITH_CUSTOM_ALLOCATORS_METHOD(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR, destroy_at)(&temporary);\
    return this;\
}\
MODIFIER STRUCT_SUBTYPE(REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR), value_type) const*\
    REFERENCE_COUNTED_WITH_CUSTOM_ALLOCATORS_METHOD(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR, get)(\
        struct REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR) const* const this) {\
    return this->value_pointer;\
}\
MODIFIER STRUCT_SUBTYPE(REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR), value_type)*\
    REFERENCE_COUNTED_WITH_CUSTOM_ALLOCATORS_METHOD(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR, mut_get)(\
        struct REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR)* const this) {\
    return this->value_pointer;\
}\
MODIFIER STRUCT_SUBTYPE(REFERENCE_COUNTED_CONTROL_BLOCK_TYPE_WITH_CUSTOM_VALUE_ALLOCATOR(VALUE_ALLOCATOR), size_type)\
    REFERENCE_COUNTED_WITH_CUSTOM_ALLOCATORS_METHOD(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR, count_owners)(\
        struct REFERENCE_COUNTED_TYPE_WITH_CUSTOM_ALLOCATORS(TYPE, VALUE_ALLOCATOR, CONTROL_BLOCK_ALLOCATOR) const* const this) {\
    return this->control_block_pointer ? (this->control_block_pointer->strong_reference_counter + 1u) : 0u;\
}

#define DEFINE_REFERENCE_COUNTED_WITH_CUSTOM_VALUE_ALLOCATOR_METHODS_WITH_MODIFIER(MODIFIER, TYPE, VALUE_ALLOCATOR)\
    DEFINE_REFERENCE_COUNTED_WITH_CUSTOM_ALLOCATORS_METHODS_WITH_MODIFIER(MODIFIER, TYPE, VALUE_ALLOCATOR,\
        DEFAULT_ALLOCATOR_TYPE(REFERENCE_COUNTED_CONTROL_BLOCK_TYPE_WITH_CUSTOM_VALUE_ALLOCATOR(VALUE_ALLOCATOR)))

#define DEFINE_REFERENCE_COUNTED_METHODS_WITH_MODIFIER(MODIFIER, TYPE)\
    DEFINE_REFERENCE_COUNTED_WITH_CUSTOM_VALUE_ALLOCATOR_METHODS_WITH_MODIFIER(MODIFIER, TYPE, DEFAULT_ALLOCATOR_TYPE(TYPE))
